#include <bits/stdc++.h>
using namespace std;

const int mySBox[] = {
    0x63,0x7C,0x77,0x7B,0xF2,0x6B,0x6F,0xC5,0x30,0x01,0x67,0x2B,0xFE,0xD7,0xAB,0x76,
    0xCA,0x82,0xC9,0x7D,0xFA,0x59,0x47,0xF0,0xAD,0xD4,0xA2,0xAF,0x9C,0xA4,0x72,0xC0,
    0xB7,0xFD,0x93,0x26,0x36,0x3F,0xF7,0xCC,0x34,0xA5,0xE5,0xF1,0x71,0xD8,0x31,0x15,
    0x04,0xC7,0x23,0xC3,0x18,0x96,0x05,0x9A,0x07,0x12,0x80,0xE2,0xEB,0x27,0xB2,0x75,
    0x09,0x83,0x2C,0x1A,0x1B,0x6E,0x5A,0xA0,0x52,0x3B,0xD6,0xB3,0x29,0xE3,0x2F,0x84,
    0x53,0xD1,0x00,0xED,0x20,0xFC,0xB1,0x5B,0x6A,0xCB,0xBE,0x39,0x4A,0x4C,0x58,0xCF,
    0xD0,0xEF,0xAA,0xFB,0x43,0x4D,0x33,0x85,0x45,0xF9,0x02,0x7F,0x50,0x3C,0x9F,0xA8,
    0x51,0xA3,0x40,0x8F,0x92,0x9D,0x38,0xF5,0xBC,0xB6,0xDA,0x21,0x10,0xFF,0xF3,0xD2,
    0xCD,0x0C,0x13,0xEC,0x5F,0x97,0x44,0x17,0xC4,0xA7,0x7E,0x3D,0x64,0x5D,0x19,0x73,
    0x60,0x81,0x4F,0xDC,0x22,0x2A,0x90,0x88,0x46,0xEE,0xB8,0x14,0xDE,0x5E,0x0B,0xDB,
    0xE0,0x32,0x3A,0x0A,0x49,0x06,0x24,0x5C,0xC2,0xD3,0xAC,0x62,0x91,0x95,0xE4,0x79,
    0xE7,0xC8,0x37,0x6D,0x8D,0xD5,0x4E,0xA9,0x6C,0x56,0xF4,0xEA,0x65,0x7A,0xAE,0x08,
    0xBA,0x78,0x25,0x2E,0x1C,0xA6,0xB4,0xC6,0xE8,0xDD,0x74,0x1F,0x4B,0xBD,0x8B,0x8A,
    0x70,0x3E,0xB5,0x66,0x48,0x03,0xF6,0x0E,0x61,0x35,0x57,0xB9,0x86,0xC1,0x1D,0x9E,
    0xE1,0xF8,0x98,0x11,0x69,0xD9,0x8E,0x94,0x9B,0x1E,0x87,0xE9,0xCE,0x55,0x28,0xDF,
    0x8C,0xA1,0x89,0x0D,0xBF,0xE6,0x42,0x68,0x41,0x99,0x2D,0x0F,0xB0,0x54,0xBB,0x16
};

int x[8], y[22], z[18], t[100], s[8];
void Us()
{
    y[14]=x[3]^x[5], y[13]=x[0]^x[6], y[9]=x[0]^x[3], y[8]=x[0]^x[5],
    t[0]=x[1]^x[2], y[1]=t[0]^x[7], y[4]=y[1]^x[3], y[12]=y[13]^y[14],
    y[2]=y[1]^x[0], y[5]=y[1]^x[6], y[3]=y[5]^y[8], t[1]=x[4]^y[12],
    y[15]=t[1]^x[5],y[20]=t[1]^x[1],y[6]=y[15]^x[7],y[10]=y[15]^t[0],
    y[11]=y[20]^y[9], y[7]=x[7]^y[11], y[17]=y[10]^y[11], y[19]=y[10]^y[8],
    y[16]=t[0]^y[11], y[21]=y[13]^y[16], y[18]=x[0]^y[16], y[0]=x[7];
}

void Fs()
{
    t[2]=y[12]&y[15], t[3]=y[3]&y[6], t[4]=t[3]^t[2], t[5]=y[4]&x[7],
    t[6]=t[5]^t[2], t[7]=y[13]&y[16], t[8]=y[5]&y[1], t[9]=t[8]^t[7],
    t[10]=y[2]&y[7], t[11]=t[10]^t[7], t[12]=y[9]&y[11], t[13]=y[14]&y[17],
    t[14]=t[13]^t[12], t[15]=y[8]&y[10], t[16]=t[15]^t[12], t[17]=t[4]^y[20],
    t[18]=t[6]^t[16], t[19]=t[9]^t[14], t[20]=t[11]^t[16], t[21]=t[17]^t[14],
    t[22]=t[18]^y[19], t[23]=t[19]^y[21], t[24]=t[20]^y[18],
    t[25]=t[21]^t[22], t[26]=t[21]&t[23], t[27]=t[24]^t[26], t[28]=t[25]&t[27],
    t[29]=t[28]^t[22], t[30]=t[23]^t[24], t[31]=t[22]^t[26], t[32]=t[31]&t[30],
    t[33]=t[32]^t[24], t[34]=t[23]^t[33], t[35]=t[27]^t[33], t[36]=t[24]&t[35],
    t[37]=t[36]^t[34], t[38]=t[27]^t[36], t[39]=t[29]&t[38], t[40]=t[25]^t[39],
    t[41]=t[40]^t[37], t[42]=t[29]^t[33], t[43]=t[29]^t[40], t[44]=t[33]^t[37],
    t[45]=t[42]^t[41], z[0]=t[44]&y[15], z[1]=t[37]&y[6], z[2]=t[33]&x[7],
    z[3]=t[43]&y[16], z[4]=t[40]&y[1], z[5]=t[29]&y[7], z[6]=t[42]&y[11],
    z[7]=t[45]&y[17], z[8]=t[41]&y[10], z[9]=t[44]&y[12], z[10]=t[37]&y[3],
    z[11]=t[33]&y[4], z[12]=t[43]&y[13], z[13]=t[40]&y[5], z[14]=t[29]&y[2],
    z[15]=t[42]&y[9], z[16]=t[45]&y[14], z[17]=t[41]&y[8];
}

void Bs()
{
    t[46]=z[15]^z[16], t[47]=z[10]^z[11], t[48]=z[5]^z[13], t[49]=z[9]^z[10],
    t[50]=z[2]^z[12], t[51]=z[2]^z[5], t[52]=z[7]^z[8], t[53]=z[0]^z[3],
    t[54]=z[6]^z[7], t[55]=z[16]^z[17], t[56]=z[12]^t[48], t[57]=t[50]^t[53],
    t[58]=z[4]^t[46], t[59]=z[3]^t[54], t[60]=t[46]^t[57], t[61]=z[14]^t[57],
    t[62]=t[52]^t[58],t[63]=t[49]^t[58],t[64]=z[4]^t[59], t[65]=t[61]^t[62],
    t[66]=z[1]^t[63], s[0]=t[59]^t[63], s[6]=(t[56]^t[62])^0x1, s[7]=(t[48]^t[60])^0x1,
    t[67]=t[64]^t[65], s[3]=t[53]^t[66], s[4]=t[51]^t[66], s[5]=t[47]^t[65],
    s[1]=(t[64]^s[3])^0x1, s[2]=(t[55]^t[67])^0x1;
}

void algorithm_4_5(int U[], int T[])
{
    U[5]=U[0]^U[5];	U[5]=U[3]^U[5];	U[5]=U[6]^U[5];
    U[4]=U[0]^U[4];	U[4]=U[3]^U[4];	U[4]=U[6]^U[4];
    T[0]=(U[4]&U[5])^T[0];	T[5]=T[0]^T[5];//(此时T[0; 5] = t2)	
            
    U[3]=U[1]^U[3];	U[3]=U[2]^U[3]; U[3]=U[7]^U[3];	
    T[0]=(U[3]&U[7])^T[0];	//(此时T[0] = t6)
            
    U[6]=U[0]^U[6];	U[2]=U[0]^U[2];	U[2]=U[4]^U[2];
    U[2]=U[5]^U[2];	U[2]=U[6]^U[2];	T[1]=(U[6]&U[2])^T[1];
    T[2]=T[1]^T[2];	//（此时T[1] = T[2] = t7）	
            
    U[1]=U[2]^U[1];	U[1]=U[4]^U[1];	U[1]=U[5]^U[1];
    U[1]=U[7]^U[1];	U[0]=U[1]^U[0];	U[0]=U[6]^U[0];
    T[1]=(U[1]&U[0])^T[1];	//（此时T[1] = t9）	

    U[6]=U[1]^U[6];	U[2]=U[0]^U[2];	T[2]=(U[6]&U[2])^T[2];
    U[3]=U[6]^U[3];	U[2]=U[7]^U[2];	T[3]=(U[3]&U[2])^T[3];
    T[4]=T[3]^T[4];	//（此时T[2] = t11; T[3] = t12）
            
    U[6]=U[1]^U[6];	U[6]=U[5]^U[6];	U[0]=U[2]^U[0];
    U[0]=U[4]^U[0];	U[0]=U[7]^U[0];	T[3]=(U[6]&U[0])^T[3];
    U[3]=U[6]^U[3];	U[0]=U[2]^U[0];	T[4]=(U[3]&U[0])^T[4];
    T[1]=T[3]^T[1];	//（此时T[3] = t14; T[4] = t16; T[1] = t19）
            
    U[3]=U[1]^U[3];	U[4]=U[7]^U[4];	T[5]=(U[3]&U[4])^T[5];
    T[3]=T[5]^T[3];	T[0]=T[4]^T[0];	T[4]=T[2]^T[4];
    //（此时T[5] = t4; T[3] = t17; T[0] = t18; T[4] = t20）
            
    U[6]=U[1]^U[6];	U[6]=U[2]^U[6];	U[6]=U[3]^U[6];
    T[3]=U[6]^T[3];	U[1]=U[0]^U[1];	U[1]=U[3]^U[1];
    T[0]=U[1]^T[0];	U[5]=U[1]^U[5];	U[5]=U[4]^U[5];
    U[5]=U[6]^U[5];	U[5]=U[7]^U[5];	T[1]=U[5]^T[1];
    U[4]=U[1]^U[4];	U[4]=U[3]^U[4];	U[4]=U[5]^U[4];
    T[4]=U[4]^T[4];	//（此时T[3] = t21; T[0] = t22; T[1] = t23; T[4] = t24）
            
    T[6]=(T[3]&T[1])^T[6];	T[3]=T[0]^T[3];	T[7]=T[4]^T[7];
    T[7]=T[6]^T[7];	T[6]=T[0]^T[6];	T[0]=(T[3]&T[7])^T[0]; 
    T[4]=T[1]^T[4]; T[9]=(T[6]&T[4])^T[9];	T[4]=T[1]^T[4];	
    //（此时T[0] = t29; T[3] = t25; T[6] = t31; T[7] = t27; T[9] = t32）
            
    T[9]=T[4]^T[9];	T[1]=T[9]^T[1];	T[7]=T[9]^T[7];
    T[8]=(T[4]&T[7])^T[8];	T[7]=T[9]^T[7];	T[1]=T[8]^T[1];
    T[7]=T[8]^T[7];	T[3]=(T[0]&T[7])^T[3];	
    //（此时T[0~9]的值分别为：T[0] = t29; T[1] = t37; T[2] = t11; T[3] = t40; T[4] = t24; T[5] = t4; T[6] = t31; T[7] = t38; T[8] = t36; T[9] = t33）
            
    U[2]=U[0]^U[2];	U[2]=U[1]^U[2];	U[2]=U[6]^U[2];
    U[4]=U[1]^U[4];	U[4]=U[3]^U[4];	U[4]=U[5]^U[4];	  

    U[6]=U[1]^U[6];	U[6]=U[3]^U[6];	U[6]=U[4]^U[6];
    U[6]=U[5]^U[6];	U[6]=U[7]^U[6];	U[0]=U[1]^U[0];
    U[0]=U[3]^U[0];	U[3]=U[0]^U[3];	U[3]=U[2]^U[3];
    U[3]=U[6]^U[3];	
//（此时U[0~7]的值分别为：U[0] = y5; U[1] = y19; U[2] = y14; U[3] = y2; U[4] = y6; U[5] = y21; U[6] = y4; U[7] = x7）  
}

void algorithm_4_6(int U[], int T[], int S[])
{
    U[3]=U[0]^U[3];	T[3]=T[0]^T[3];	S[2]=(T[3]&U[3])^S[2];
    S[6]=S[2]^S[6];	U[3]=U[0]^U[3];	T[3]=T[0]^T[3];
    S[2]=(T[0]&U[3])^S[2];	S[5]=S[2]^S[5];	//（此时S[2]为z14）
            
    U[6]=U[0]^U[6];	U[6]=U[1]^U[6];	U[6]=U[2]^U[6];
    U[6]=U[4]^U[6];	U[6]=U[5]^U[6];	S[4]=(T[0]&U[6])^S[4];
    S[6]=S[4]^S[6];	U[6]=U[0]^U[6];	U[6]=U[1]^U[6];
    U[6]=U[2]^U[6];	U[6]=U[4]^U[6];	U[6]=U[5]^U[6];
    S[1]=(T[1]&U[4])^S[1];	S[3]=S[1]^S[3];	S[4]=S[1]^S[4];
    //（此时S[4] = z5，S[1] = z1）
            
    U[6]=U[1]^U[6];	U[6]=U[2]^U[6];	U[6]=U[3]^U[6];
    T[3]=T[1]^T[3];	S[7]=(T[3]&U[6])^S[7];	S[4]=S[7]^S[4];
    S[6]=S[7]^S[6];	U[6]=U[1]^U[6];	U[6]=U[2]^U[6];
    U[6]=U[3]^U[6];	T[3]=T[1]^T[3];	//（此时S[7]为z8）
            
    S[7]=(T[9]&U[7])^S[7];	S[1]=S[7]^S[1];	S[3]=S[7]^S[3];
    S[4]=S[7]^S[4];	//（此时S[7] = z2）

    U[4]=U[7]^U[4];	T[1]=T[9]^T[1];	S[7]=(T[1]&U[4])^S[7];
    S[1]=S[7]^S[1];	S[2]=S[7]^S[2];	S[3]=S[7]^S[3];
    S[5]=S[7]^S[5];	U[4]=U[7]^U[4];	T[1]=T[9]^T[1];
    S[6]=(T[3]&U[0])^S[6];	S[7]=S[6]^S[7];	//（此时S[6] = z13）
            
    U[5]=U[0]^U[5];	U[5]=U[3]^U[5];	T[3]=T[0]^T[3];
    S[0]=(T[3]&U[5])^S[0];	S[4]=S[0]^S[4];	S[6]=S[0]^S[6];
    S[7]=S[0]^S[7];	U[5]=U[0]^U[5];	U[5]=U[3]^U[5];
    T[3]=T[0]^T[3];	//（此时S[0] = z3）
            
    U[6]=U[1]^U[6];	U[6]=U[2]^U[6];	U[6]=U[3]^U[6];
    U[6]=U[4]^U[6];	S[0]=(T[3]&U[6])^S[0];	S[1]=S[0]^S[1];
    S[2]=S[0]^S[2];	S[3]=S[0]^S[3];	S[4]=S[0]^S[4];
    S[5]=S[0]^S[5];	S[6]=S[0]^S[6];	U[6]=U[1]^U[6];
    U[6]=U[2]^U[6];	U[6]=U[3]^U[6];	U[6]=U[4]^U[6];
    //（此时S[0] = z4）
            
    U[7]=U[0]^U[7];	U[7]=U[1]^U[7];	U[7]=U[2]^U[7];
    U[7]=U[4]^U[7];	U[7]=U[5]^U[7];	U[7]=U[6]^U[7];
    T[9]=T[0]^T[9];	S[0]=(T[9]&U[7])^S[0]; S[2]=S[0]^S[2];
    S[5]=S[0]^S[5];	S[6]=S[0]^S[6];	U[7]=U[0]^U[7];
    U[7]=U[1]^U[7];	U[7]=U[2]^U[7];	U[7]=U[4]^U[7];
    U[7]=U[5]^U[7];	U[7]=U[6]^U[7];	T[9]=T[0]^T[9];
    //（此时S[0] = z6）
            
    U[7]=U[0]^U[7];	U[7]=U[3]^U[7];	U[7]=U[4]^U[7];
    U[7]=U[5]^U[7];	T[9]=T[0]^T[9];	T[9]=T[3]^T[9];
    T[9]=T[1]^T[9];	S[0]=(T[9]&U[7])^S[0];	S[3]=S[0]^S[3];
    S[4]=S[0]^S[4];	S[5]=S[0]^S[5];	S[6]=S[0]^S[6];
    U[7]=U[0]^U[7];	U[7]=U[3]^U[7];	U[7]=U[4]^U[7];
    U[7]=U[5]^U[7];	T[9]=T[0]^T[9];	T[9]=T[3]^T[9];
    T[9]=T[1]^T[9];	//（此时S[0] = z7）

    U[3]=U[0]^U[3];	U[3]=U[2]^U[3];	T[9]=T[1]^T[9];
    S[0]=(T[9]&U[3])^S[0];	S[5]=S[0]^S[5];	U[3]=U[0]^U[3];
    U[3]=U[2]^U[3];	T[9]=T[1]^T[9];	//（此时S[0] = z9）
            
    U[6]=U[0]^U[6];	U[6]=U[2]^U[6];	U[6]=U[3]^U[6];
    S[0]=(T[1]&U[6])^S[0];	S[6]=S[0]^S[6];	S[7]=S[0]^S[7];
    U[6]=U[0]^U[6];	U[6]=U[2]^U[6];	U[6]=U[3]^U[6];
    //（此时S[0] = z10）
            
    T[9]=T[0]^T[9];	T[9]=T[3]^T[9];	T[9]=T[1]^T[9];
    S[0]=(T[9]&U[2])^S[0];	S[2]=S[0]^S[2];	T[9]=T[0]^T[9];
    T[9]=T[3]^T[9];	T[9]=T[1]^T[9];	//（此时S[0] = z16）
            
    U[6]=U[3]^U[6];	T[9]=T[0]^T[9];	S[0]=(T[9]&U[6])^S[0];
    S[1]=S[0]^S[1];	S[2]=S[0]^S[2];	S[3]=S[0]^S[3];
    S[4]=S[0]^S[4];	S[5]=S[0]^S[5];	S[6]=S[0]^S[6];
    S[7]=S[0]^S[7];	U[6]=U[3]^U[6];	T[9]=T[0]^T[9];
    //（此时S[0] = z15）
            
    U[6]=U[2]^U[6];	U[6]=U[3]^U[6];	S[2]=(T[8]&U[6])^S[2];
    U[6]=U[2]^U[6];	U[6]=U[3]^U[6];	S[5]=(T[9]&U[6])^S[5];
    S[1] = S[1] ^ 0x1;	S[2] = S[2] ^ 0x1;	S[6] = S[6] ^ 0x1;
    S[7] = S[7] ^ 0x1;		
    //（计算完成，输出S[0~7]）
}

int main()
{
    int U[8] = {0}, T[10] = {0}, S[8] = {0};

    int num = 147;
    cout << "input :" << num << endl;
    cout << "S-Box Decimal output: " << mySBox[num] << "\n"
         << "S-Box Binary  output: " << bitset<8>(mySBox[num]) << "\n\n";
         
    for(int i = 0; i < 8; ++i)
        x[i] = U[i] = ( num >> (7-i) ) & 0x1;
    
    Us(); Fs(); Bs();
    string str1;
    for(int i = 0; i < 8; ++i)
        str1 += (s[i] + '0');
    cout << "Boyar Tower structure is: " << str1 << "\n\n";
    
    algorithm_4_5(U, T);
    cout << "-----------temporary value-----------\n";
    printf("t29 : (%d, %d)\n", t[29], T[0]);
    printf("t37 : (%d, %d)\n", t[37], T[1]);
    printf("t11 : (%d, %d)\n", t[11], T[2]);
    printf("t40 : (%d, %d)\n", t[40], T[3]);
    printf("t24 : (%d, %d)\n", t[24], T[4]);
    printf("t4  : (%d, %d)\n", t[4 ], T[5]);
    printf("t31 : (%d, %d)\n", t[31], T[6]);
    printf("t38 : (%d, %d)\n", t[38], T[7]);
    printf("t36 : (%d, %d)\n", t[36], T[8]);
    printf("t33 : (%d, %d)\n", t[33], T[9]);

    printf("y5  : (%d, %d)\n", y[5 ], U[0]);
    printf("y19 : (%d, %d)\n", y[19], U[1]);
    printf("y14 : (%d, %d)\n", y[14], U[2]);
    printf("y2  : (%d, %d)\n", y[2 ], U[3]);
    printf("y6  : (%d, %d)\n", y[6 ], U[4]);
    printf("y21 : (%d, %d)\n", y[21], U[5]);
    printf("y4  : (%d, %d)\n", y[4 ], U[6]);
    printf("y7  : (%d, %d)\n", x[7 ], U[7]);
    cout << "-----------temporary value-----------\n";
    
    cout << "\n";
    algorithm_4_6(U, T, S);
    string str2;
    for(int i = 0; i < 8; ++i)
        str2 += (S[i] + '0');
    cout << "our algorithm output is: " << str2 << endl;

    return 0;
}
